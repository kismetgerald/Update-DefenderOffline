# Update-DefenderOffline

> Automate Microsoft Defender antivirus definition updates for air-gapped and offline Windows systems

[![PowerShell](https://img.shields.io/badge/PowerShell-5.1%2B-blue.svg)](https://github.com/PowerShell/PowerShell)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE.txt)
[![Version](https://img.shields.io/badge/Version-0.0.6-orange.svg)](https://github.com/kismetgerald/Update-DefenderOffline)

## Overview

**Update-DefenderOffline** is a PowerShell script that updates Microsoft Defender definitions on systems without internet access using PowerShell Remoting (WinRM). Perfect for air-gapped networks, SCADA systems, and high-security environments.

**Key Features:**
- üöÄ **10x faster** with PowerShell 7+ parallel processing (up to 32 threads)
- üìä **Real-time dashboard** with live progress tracking
- üîÑ **Auto-discovery** of computers from Active Directory
- üîß **Email notifications** with detailed HTML reports
- üõ°Ô∏è **Safe & tested** with dry-run mode and automatic retry logic
- ‚öôÔ∏è **Enterprise-ready** for scheduled tasks and service accounts
- üìà **Version analytics** with fleet-wide statistics and CSV exports

## Prerequisites Checklist

**Before running, ensure you have:**

- ‚òê **PowerShell 5.1 or higher** (7+ strongly recommended for parallel performance)
- ‚òê **Administrator privileges** on the machine running the script
- ‚òê **Administrative rights** on all target computers
- ‚òê **WinRM enabled** on target computers (TCP port 5985)
- ‚òê **Network share** accessible from all target systems
- ‚òê **Firewall rules** allow TCP 5985 between systems
- ‚òê **Latest mpam-fe.exe** (x64 version) on network share
- ‚òê **Domain membership** OR ActiveDirectory PowerShell module (for auto-discovery)

### Quick Environment Test

Run this on target computers to verify readiness:

```powershell
# Test WinRM connectivity
Test-WSMan -ComputerName localhost

# Enable WinRM if needed
Enable-PSRemoting -Force

# Verify Defender service
Get-Service WinDefend | Select-Object Status, StartType
```

## Quick Start Guide

### Step 1: Download Latest Definitions

On an **internet-connected** machine:

1. Visit [Microsoft Malware Protection Center](https://go.microsoft.com/fwlink/?LinkID=121721&arch=x64)
2. Download `mpam-fe.exe` (x64 version) - usually 150-250 MB
3. Copy to your network share (e.g., `\\fileserver\DefenderUpdates\`)

**Note:** The script automatically detects the newest mpam-fe file by modification date, so you don't need to rename files with version numbers.

### Step 2: First Run

Open **PowerShell as Administrator** and navigate to the script directory:

```powershell
# Auto-discover domain computers and create hosts.conf
.\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\DefenderUpdates" `
    -MpamFileName "mpam-feX64.exe"
```

**What happens during first run:**
1. ‚úì Script validates you're running as Administrator
2. ‚úì Creates `C:\Logs\` and `.\Reports\` folders
3. ‚úì Queries Active Directory for all Windows computers
4. ‚úì Auto-generates `hosts.conf` with discovered systems
5. ‚úì Tests WinRM connectivity to each computer
6. ‚úì Copies definition file and installs silently
7. ‚úì Verifies new version installed successfully
8. ‚úì Generates HTML report with detailed results

### Step 3: Review and Customize

After the first run, review `hosts.conf` in the script directory:

```
# =============================================================================
# hosts.conf ‚Äì AUTO-GENERATED by Update-DefenderOffline.ps1 v0.0.6
# Generated      : 2026-01-28 10:30:45
# Domain         : contoso.com
# Total Systems  : 250
# Edit this file to exclude lab/test machines if needed
# =============================================================================

WORKSTATION01
WORKSTATION02
SERVER01
# TESTLAB-PC01  # Comment out systems to exclude
```

**Edit this file** to exclude test/lab machines or add systems not in AD.

## Target Computer Discovery Options

### Option 1: Auto-Discovery from Active Directory (Recommended)

**Requirements:**
- Domain-joined machine OR ActiveDirectory PowerShell module installed
- Read access to Active Directory

Just run the script without `-ComputerName` parameter. The script will:
- Query AD for all enabled Windows computers
- Create `hosts.conf` automatically
- Use this file for future runs

```powershell
.\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\DefenderUpdates" `
    -MpamFileName "mpam-feX64.exe"
```

**If AD query fails:** The script will throw an error asking you to create `hosts.conf` manually (see Option 3).

### Option 2: Manual Computer List

Provide specific computers via parameter (bypasses hosts.conf):

```powershell
.\Update-DefenderOffline.ps1 `
    -ComputerName "PC01","PC02","SERVER01" `
    -SourceSharePath "\\fileserver\DefenderUpdates" `
    -MpamFileName "mpam-feX64.exe"
```

**Use cases:**
- Workgroup environments (no Active Directory)
- Testing on specific systems
- Updating a subset of computers

### Option 3: Create hosts.conf Manually

Create a file named `hosts.conf` in the script directory:

```
# One computer name per line
# Lines starting with # are comments and will be ignored
# Computer names are case-insensitive

WORKSTATION01
WORKSTATION02
SERVER01
# TESTLAB-PC01  # Commented out - will be skipped
```

**Format rules:**
- One computer name per line
- Lines starting with `#` are ignored
- Blank lines are ignored
- Names are automatically converted to uppercase
- Supports NetBIOS names or FQDNs

## Common Scenarios

### Weekly Scheduled Updates

Create a scheduled task to run weekly:

```powershell
# Run via Task Scheduler
.\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\updates" `
    -MpamFileName "mpam-feX64.exe"
```

**Tip:** The script automatically picks the newest `mpam-fe*.exe` file by LastWriteTime, so you can just drop new files in the share.

### With Email Notifications

#### One-Time Setup: Save SMTP Credentials

```powershell
# Interactive credential prompt
.\Update-DefenderOffline.ps1 -SaveSmtpCredential
```

This creates `.\Config\SmtpCredential.xml` with encrypted credentials (per-user + per-machine encryption via DPAPI).

#### Production Run with Email

```powershell
# Load saved credentials
$cred = Import-Clixml ".\Config\SmtpCredential.xml"

# Run with email enabled
.\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\updates" `
    -MpamFileName "mpam-feX64.exe" `
    -SendEmail `
    -SmtpServer "smtp.company.com" `
    -SmtpPort 587 `
    -SmtpUseSsl `
    -From "defender@company.com" `
    -To "it-team@company.com","security@company.com" `
    -SmtpCredential $cred
```

**Email includes:**
- HTML-formatted summary
- Success/failure statistics
- Attached full HTML report
- Version history analytics

### Dry-Run Testing

Test the script without making any changes:

```powershell
.\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\updates" `
    -MpamFileName "mpam-feX64.exe" `
    -WhatIfMode
```

**What happens in dry-run:**
- ‚úì All connectivity tests performed
- ‚úì Computer list validated
- ‚úì Source file verified
- ‚úó No files copied
- ‚úó No installations performed
- ‚úì Report generated showing what would happen

### High-Performance Mode (PowerShell 7+)

For large environments (500+ computers), use PowerShell 7 with maximum threads:

```powershell
# Install PowerShell 7 if needed
winget install Microsoft.PowerShell

# Run with 32 concurrent threads
pwsh.exe -File .\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\updates" `
    -MpamFileName "mpam-feX64.exe" `
    -ParallelThreads 32
```

**Performance tip:** The script includes a real-time dashboard that updates every 5 seconds showing:
- Running jobs
- Pending queue
- Completed count
- Active computers
- Elapsed time

### With Remote Log Collection

Collect installation logs from all computers to a central share:

```powershell
.\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\updates" `
    -MpamFileName "mpam-feX64.exe" `
    -LogSharePath "\\fileserver\DefenderLogs"
```

**Creates structure:**
```
\\fileserver\DefenderLogs\
‚îú‚îÄ‚îÄ WORKSTATION01\
‚îÇ   ‚îú‚îÄ‚îÄ install_20260128_103045.log
‚îÇ   ‚îî‚îÄ‚îÄ install_20260128_103045.log.err
‚îú‚îÄ‚îÄ WORKSTATION02\
‚îÇ   ‚îî‚îÄ‚îÄ install_20260128_103112.log
‚îî‚îÄ‚îÄ SERVER01\
    ‚îî‚îÄ‚îÄ install_20260128_103201.log
```

## What Actually Happens During Execution

Understanding the workflow helps troubleshoot issues:

### Phase 1: Initialization (5-10 seconds)
1. Validates administrative privileges ‚Üí exits if not admin
2. Creates output folders (`C:\Logs\`, `.\Reports\`)
3. Initializes thread-safe logging
4. Detects PowerShell version (7+ = parallel, 5.1 = serial)

### Phase 2: Target Discovery (10-30 seconds)
1. Checks for `-ComputerName` parameter ‚Üí use if provided
2. Else checks for `hosts.conf` ‚Üí load if exists
3. Else queries Active Directory ‚Üí auto-create hosts.conf
4. Validates at least one target found

### Phase 3: Source Validation (1-2 seconds)
1. Scans `-SourceSharePath` for `mpam-fe*.exe` files
2. Selects newest file by LastWriteTime
3. Verifies file exists and is accessible

### Phase 4: Update Execution (varies by computer count)

**For each computer:**

1. **Connectivity Test** (2-5 sec)
   - Test-NetConnection on port 5985
   - If fails ‚Üí mark as "Failed: WinRM not reachable"

2. **Session Creation** (1-2 sec)
   - New-PSSession to target computer
   - If fails ‚Üí mark as "Failed: Authentication/Access Denied"

3. **Pre-Check** (1-2 sec)
   - Verify Windows Defender service is running
   - Get current definition version

4. **File Transfer** (5-15 sec, depends on network speed)
   - Create temp folder on target: `C:\Temp\Update-DefenderOffline\`
   - Copy mpam-fe.exe (~200 MB) via PSSession

5. **Installation** (10-30 sec)
   - Execute: `mpam-fe.exe /q` (silent install)
   - Wait for process completion
   - Capture exit code and logs

6. **Verification** (1-2 sec)
   - Query new definition version
   - Compare with pre-install version
   - Determine status: Success / Failed / No Update Needed

7. **Log Collection** (2-5 sec, if configured)
   - Copy installation logs to network share
   - Create per-computer subdirectory

8. **Cleanup** (1-2 sec)
   - Remove temp folder on target
   - Close PSSession

**Retry Logic (v0.0.6 feature):**
- Soft failures (network glitches, timeouts) ‚Üí retry up to 3 times
- Hard failures (WinRM disabled, access denied) ‚Üí fail immediately
- 5-minute timeout per computer

### Phase 5: Reporting (5-10 seconds)
1. Generate HTML report with version analytics
2. Export CSV with detailed results
3. Calculate fleet-wide statistics:
   - Oldest version found
   - Newest version applied
   - Average version delta
4. Send email notification (if configured)

### Phase 6: Summary Display
- Console output with color-coded results
- Total execution time
- Success/failure/skipped counts
- Link to HTML report

## Output & Logs

### Console Output (Color-Coded)

```
2026-01-28 10:30:45 [HEADER] === Microsoft Defender Offline Update v0.0.6 ===
2026-01-28 10:30:45 [INFO] Started          : 1/28/2026 10:30:45 AM
2026-01-28 10:30:45 [INFO] PowerShell       : 7.4.0 (Core)
2026-01-28 10:30:45 [INFO] Parallel Mode    : ENABLED (16 threads)
2026-01-28 10:30:46 [SUCCESS] Loaded 250 computers from hosts.conf
2026-01-28 10:35:12 [HEADER] UPDATE COMPLETE in 00:04:27
2026-01-28 10:35:12 [HEADER] Success: 245 | Failed: 3 | Skipped: 2
2026-01-28 10:35:12 [SUCCESS] Report saved: .\Reports\DefenderUpdateReport_20260128_103045.html
```

**Color Legend:**
- üü£ **HEADER** (Magenta): Section headers and major milestones
- üîµ **INFO** (Cyan): Informational messages and progress
- üü¢ **SUCCESS** (Green): Successful operations
- üü° **WARN** (Yellow): Warnings and fallback operations
- üî¥ **ERROR** (Red): Failures and critical issues

### Real-Time Dashboard (PowerShell 7+)

```
=== Defender Update Dashboard ===
Running:     16
Pending:     234
Completed:   0
Active:      WS01, WS02, WS03, WS04, SRV01, ...
Elapsed:     00:02:15
```

Updates every 5 seconds without scrolling.

### Log Files

**Primary log:** `C:\Logs\Update-DefenderOffline_YYYYMMDD_HHmmss.log`

```
2026-01-28 10:30:45 [HEADER] === Microsoft Defender Offline Update v0.0.6 ===
2026-01-28 10:30:45 [INFO] Started          : 1/28/2026 10:30:45 AM
2026-01-28 10:30:45 [INFO] PowerShell       : 7.4.0 (Core)
2026-01-28 10:30:45 [INFO] Parallel Mode    : ENABLED (16 threads)
2026-01-28 10:30:46 [SUCCESS] Loaded 250 computers from hosts.conf
2026-01-28 10:30:47 [INFO] Latest mpam-fe package detected: mpam-feX64.exe
2026-01-28 10:32:15 [INFO] VersionHistory: WORKSTATION01 Old=1.405.233.0 New=1.405.1245.0 Delta=1012
2026-01-28 10:32:18 [INFO] VersionHistory: WORKSTATION02 Old=1.405.1245.0 New=1.405.1245.0 Delta=0
2026-01-28 10:35:12 [HEADER] UPDATE COMPLETE in 00:04:27
```

**Per-host logs:** `C:\Logs\PerHost\COMPUTERNAME.log` (v0.0.6 feature)

```
1/28/2026 10:32:15 AM Attempt 1: Success - 1.405.233.0 ‚Üí 1.405.1245.0
```

**Remote logs:** `\\fileserver\DefenderLogs\COMPUTERNAME\install_*.log` (if `-LogSharePath` configured)

### HTML Reports

**Location:** `.\Reports\DefenderUpdateReport_YYYYMMDD_HHmmss.html`

**Includes:**
- Run date, source file, total duration
- Version history summary:
  - Oldest version found
  - Newest version applied
  - Average version delta
  - Hosts already current/updated/failed counts
- Detailed results table (sortable):
  - Computer name
  - Status (color-coded: Success/Failed/No Update Needed)
  - Old version
  - New version
  - Duration in seconds
  - Retry attempts
  - Timeout status
  - Details/error messages
- Link to full log file

**Professional styling:**
- Modern responsive design
- Color-coded status indicators
- Alternating row colors for readability
- Embedded CSS (no external dependencies)

### CSV Export (v0.0.6 feature)

**Location:** `.\Reports\DefenderUpdateReport_YYYYMMDD_HHmmss.csv`

```csv
ComputerName,Status,OldVersion,NewVersion,DurationSec,Delta,Details
WORKSTATION01,Success,1.405.233.0,1.405.1245.0,12.34,1012,1.405.233.0 ‚Üí 1.405.1245.0
WORKSTATION02,No Update Needed,1.405.1245.0,1.405.1245.0,8.21,0,Already current
SERVER01,Failed,1.405.100.0,,45.67,Unknown,WinRM (5985) not reachable
```

**Use cases:**
- Import into Excel for analysis
- Create pivot tables
- Track version compliance over time
- Generate custom reports

## Requirements

| Component | Requirement | Notes |
|-----------|-------------|-------|
| PowerShell | 5.1 minimum (7+ recommended) | PS 7+ enables parallel processing |
| Privileges | Administrator on local machine | Script validates on startup |
| Remote Access | Administrator on target systems | Required for WinRM |
| Network | WinRM enabled on targets (port 5985) | Use `Enable-PSRemoting -Force` |
| Source File | mpam-fe.exe (x64) on accessible share | ~150-250 MB download from Microsoft |
| Optional | ActiveDirectory module OR domain membership | For auto-discovery from AD |
| Optional | SMTP server access | For email notifications |

### Network Requirements

**Firewall ports:**
- TCP 5985 (WinRM HTTP) - required for PowerShell Remoting
- TCP 445 (SMB) - required for file transfer to/from network shares

**Network share permissions:**
- Source share: READ access for service account
- Log share: WRITE access for service account (if using `-LogSharePath`)

## Configuration Options

### Required Parameters

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `-SourceSharePath` | string | Network path containing mpam-fe.exe | `\\fileserver\updates` |
| `-MpamFileName` | string | Exact filename of update package | `mpam-feX64.exe` |

### Optional Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `-ComputerName` | string[] | *(auto-discover)* | Manual list of target computers |
| `-TempFolderOnTarget` | string | `C:\Temp\Update-DefenderOffline` | Temp directory on remote systems |
| `-LogPath` | string | `C:\Logs` | Local log storage directory |
| `-ReportPath` | string | `.\Reports` | HTML report output directory |
| `-LogSharePath` | string | *(disabled)* | Network share for remote log collection |
| `-ParallelThreads` | int | `16` | Max concurrent threads (PS 7+ only, range: 1-32) |
| `-WhatIfMode` | switch | `false` | Dry-run mode (no changes made) |

### Email Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `-SendEmail` | switch | `false` | Enable email notifications |
| `-SmtpServer` | string | *(required if -SendEmail)* | SMTP server address |
| `-SmtpPort` | int | `25` | SMTP port number |
| `-SmtpUseSsl` | switch | `false` | Use SSL/TLS for SMTP |
| `-From` | string | `DefenderUpdate@contoso.com` | Email sender address |
| `-To` | string[] | *(required if -SendEmail)* | Email recipient(s) - supports multiple |
| `-SmtpCredential` | PSCredential | *(optional)* | SMTP authentication credentials |

### Special Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `-SaveSmtpCredential` | switch | Interactive helper to save encrypted SMTP credentials |

**Get full help:**
```powershell
Get-Help .\Update-DefenderOffline.ps1 -Full
```

## Troubleshooting

### Common Issues

#### ‚ùå "This script requires administrative privileges"

**Cause:** Script is not running with elevated permissions.

**Solution:**
```powershell
# Right-click PowerShell ‚Üí "Run as Administrator"
# Or from elevated prompt:
Start-Process powershell -Verb RunAs
```

**Verification:**
```powershell
# Check if running as admin:
([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
# Should return: True
```

---

#### ‚ùå "WinRM (5985) not reachable"

**Cause:** Target computer doesn't have PowerShell Remoting enabled.

**Solution - On Each Target Computer:**
```powershell
# Enable WinRM (requires admin rights)
Enable-PSRemoting -Force

# Verify WinRM is running
Get-Service WinRM | Select-Object Status, StartType
# Status should be: Running
# StartType should be: Automatic

# Test locally
Test-WSMan -ComputerName localhost
```

**Solution - Via Group Policy (Domain Environments):**
1. Open Group Policy Management Console
2. Edit appropriate GPO
3. Navigate to: `Computer Configuration ‚Üí Policies ‚Üí Administrative Templates ‚Üí Windows Components ‚Üí Windows Remote Management (WinRM) ‚Üí WinRM Service`
4. Enable: "Allow remote server management through WinRM"
5. Set IPv4/IPv6 filters: `*` (or specific ranges)
6. Run `gpupdate /force` on target computers

**Network Troubleshooting:**
```powershell
# Test TCP connectivity to port 5985
Test-NetConnection -ComputerName TARGETPC -Port 5985

# Check Windows Firewall rules
Get-NetFirewallRule -DisplayName "Windows Remote Management*" | Select-Object DisplayName, Enabled
```

---

#### ‚ùå "Cannot find path '\\fileserver\updates'"

**Cause:** Network share is not accessible or permissions are insufficient.

**Solution:**
```powershell
# Test share accessibility
Test-Path "\\fileserver\updates"

# List files in share
Get-ChildItem "\\fileserver\updates"

# Check current user context
whoami

# Map share temporarily to test permissions
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\fileserver\updates"
Get-ChildItem Z:\
```

**Permissions Checklist:**
- ‚òê Share permissions: READ for service account
- ‚òê NTFS permissions: READ & EXECUTE for service account
- ‚òê Network path uses UNC format (not mapped drives)
- ‚òê Service account is not a local account (use domain account)

---

#### ‚ùå "Cannot proceed without target list. Create hosts.conf manually."

**Cause:** Auto-discovery from Active Directory failed, and no hosts.conf exists.

**Possible reasons:**
1. Machine is not domain-joined
2. ActiveDirectory PowerShell module not installed
3. Insufficient AD permissions
4. Domain controller unreachable

**Solution 1 - Manual hosts.conf:**
```powershell
# Create hosts.conf in script directory
@"
WORKSTATION01
WORKSTATION02
SERVER01
"@ | Out-File -FilePath ".\hosts.conf" -Encoding UTF8
```

**Solution 2 - Install ActiveDirectory Module (Windows 10/11/Server):**
```powershell
# Windows 10/11 (requires RSAT)
Add-WindowsCapability -Online -Name Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0

# Windows Server
Install-WindowsFeature -Name RSAT-AD-PowerShell
```

**Solution 3 - Use -ComputerName Parameter:**
```powershell
.\Update-DefenderOffline.ps1 `
    -ComputerName "PC01","PC02","SERVER01" `
    -SourceSharePath "\\fileserver\updates" `
    -MpamFileName "mpam-feX64.exe"
```

---

#### ‚ùå "Access is denied" / Authentication Failures

**Cause:** Insufficient permissions on target systems.

**Solution:**
```powershell
# Verify you have admin rights on target
Invoke-Command -ComputerName TARGETPC -ScriptBlock { 
    ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}
# Should return: True

# Check if target is in TrustedHosts (workgroup environments)
Get-Item WSMan:\localhost\Client\TrustedHosts

# Add target to TrustedHosts if needed
Set-Item WSMan:\localhost\Client\TrustedHosts -Value "TARGETPC" -Concatenate -Force
```

**Domain Environment:**
- Use domain admin account or delegated credentials
- Verify service account is in "Administrators" group on targets

**Workgroup Environment:**
- Configure TrustedHosts on both sides
- Use explicit credentials: `-Credential (Get-Credential)`

---

#### ‚ö†Ô∏è No progress updates in parallel mode

**Cause:** Running PowerShell 5.1 instead of PowerShell 7+.

**Check Version:**
```powershell
$PSVersionTable.PSVersion
# Should show: 7.x.x for parallel support
```

**Solution - Install PowerShell 7:**
```powershell
# Using winget (Windows 10/11)
winget install Microsoft.PowerShell

# Using MSI installer
# Download from: https://github.com/PowerShell/PowerShell/releases

# Verify installation
pwsh -Version
```

**Run Script with PowerShell 7:**
```powershell
pwsh.exe -File .\Update-DefenderOffline.ps1 `
    -SourceSharePath "\\fileserver\updates" `
    -MpamFileName "mpam-feX64.exe"
```

---

#### ‚ö†Ô∏è "Windows Defender service not running"

**Cause:** Defender service is stopped or disabled on target.

**Solution - On Target Computer:**
```powershell
# Check service status
Get-Service WinDefend | Select-Object Status, StartType

# Start service
Start-Service WinDefend

# Set to automatic startup
Set-Service WinDefend -StartupType Automatic
```

**Verify Defender is Enabled:**
```powershell
Get-MpComputerStatus | Select-Object AntivirusEnabled, RealTimeProtectionEnabled
```

---

#### ‚ö†Ô∏è Email not sending

**Causes:**
- SMTP server not reachable
- Authentication failure
- SSL/TLS configuration mismatch
- Firewall blocking SMTP port

**Troubleshooting:**
```powershell
# Test SMTP connectivity
Test-NetConnection -ComputerName smtp.company.com -Port 587

# Test without credentials first
Send-MailMessage -From "test@company.com" -To "test@company.com" `
    -Subject "Test" -Body "Test" -SmtpServer "smtp.company.com" -Port 25

# Check saved credentials
$cred = Import-Clixml ".\Config\SmtpCredential.xml"
$cred.UserName
# Verify username is correct

# Re-save credentials if needed
.\Update-DefenderOffline.ps1 -SaveSmtpCredential
```

**Common SMTP Ports:**
- Port 25: Unencrypted (use `-SmtpUseSsl:$false`)
- Port 587: STARTTLS (use `-SmtpUseSsl`)
- Port 465: SSL (use `-SmtpUseSsl`)

---

#### ‚ö†Ô∏è Slow performance even with PowerShell 7

**Possible Causes:**
1. Network bandwidth limitations
2. Too many concurrent threads
3. Slow target computers
4. Large mpam-fe.exe file

**Optimization Tips:**
```powershell
# Reduce threads if network is saturated
.\Update-DefenderOffline.ps1 ... -ParallelThreads 8

# Increase threads if network has capacity
.\Update-DefenderOffline.ps1 ... -ParallelThreads 24

# Monitor network utilization
Get-NetAdapterStatistics | Select-Object Name, ReceivedBytes, SentBytes
```

**Expected Performance:**
- File transfer: ~5-15 seconds per computer (depends on network speed)
- Installation: ~10-30 seconds per computer
- Total per computer: ~15-45 seconds on average

---

### Getting Additional Help

**View detailed examples:**
```powershell
Get-Help .\Update-DefenderOffline.ps1 -Examples
```

**View all parameters:**
```powershell
Get-Help .\Update-DefenderOffline.ps1 -Parameter *
```

**Check script version:**
```powershell
# Look for version in log header
Get-Content "C:\Logs\Update-DefenderOffline_*.log" -First 5
```

**Enable verbose logging:**
```powershell
.\Update-DefenderOffline.ps1 ... -Verbose
```

## Performance Benchmarks

Real-world performance based on testing with ~200 MB mpam-fe.exe file:

| Computers | PS 5.1 (Serial) | PS 7+ (8 threads) | PS 7+ (16 threads) | PS 7+ (32 threads) |
|-----------|-----------------|-------------------|--------------------|--------------------|
| 10 | ~3 min | ~2 min | ~1 min | ~1 min |
| 50 | ~15 min | ~8 min | ~4 min | ~3 min |
| 100 | ~30 min | ~15 min | ~8 min | ~5 min |
| 250 | ~75 min | ~40 min | ~20 min | ~12 min |
| 500 | ~150 min | ~80 min | ~40 min | ~25 min |
| 1000 | ~300 min | ~160 min | ~80 min | ~50 min |

**Assumptions:**
- Average 15-20 seconds per computer
- 1 Gbps network
- No connectivity failures
- Includes retry logic overhead

**Variables affecting performance:**
- Network speed between script host and targets
- Network speed between targets and file share
- Target computer CPU/disk speed
- Number of simultaneous updates running
- File size of mpam-fe.exe (~150-250 MB)

**Optimization recommendations:**
- **<50 computers:** PS 5.1 is fine, or PS 7+ with 8 threads
- **50-250 computers:** PS 7+ with 16 threads (default)
- **250-500 computers:** PS 7+ with 24 threads
- **500+ computers:** PS 7+ with 32 threads
- **1000+ computers:** Consider breaking into batches or using separate script instances

## New Features in v0.0.6

### üéØ Automatic Retry Logic
- Soft failures (network glitches, timeouts) automatically retry up to 3 times
- Hard failures (WinRM disabled, access denied) fail immediately without retries
- Per-computer retry tracking in reports

### üìä Real-Time Dashboard (PowerShell 7+)
- Live dashboard updates every 5 seconds
- Shows: Running jobs, Pending queue, Completed count, Active computers, Elapsed time
- Non-scrolling display for clean monitoring

### ‚è±Ô∏è Timeout Protection
- 5-minute timeout per computer prevents hung jobs
- Automatic cleanup of timed-out sessions
- Timeout status tracked in reports

### üìà Version Analytics
- Fleet-wide version statistics (oldest, newest, average delta)
- Per-computer version history logging
- CSV export for trend analysis

### üîç Enhanced Failure Classification
- Distinguishes between retryable and hard failures
- Detailed failure reasons (WinRM, authentication, timeout, etc.)
- Per-host log files track retry attempts

### üõ°Ô∏è Pre-Update Health Checks
- Verifies Windows Defender service is running before attempting updates
- Prevents unnecessary file transfers to unhealthy systems

### üìÅ Per-Host Logging
- Individual log files: `C:\Logs\PerHost\COMPUTERNAME.log`
- Tracks all retry attempts and outcomes
- Easier troubleshooting for specific computers

### üìß Improved Email Reports
- Includes version analytics in email body
- Retry and timeout information in attached report
- CSV export attached for detailed analysis

## Version History

### v0.0.6 (2026-01-28) - Current
- ‚ú® Added automatic retry logic with smart failure classification
- ‚ú® Implemented real-time dashboard for parallel mode (PowerShell 7+)
- ‚ú® Added 5-minute timeout protection per computer
- ‚ú® Added fleet-wide version analytics and statistics
- ‚ú® Added per-host logging in `C:\Logs\PerHost\`
- ‚ú® Added CSV export for detailed analysis
- ‚ú® Added pre-update health check for Defender service
- üêõ Fixed scoping issues with parallel execution
- üêõ Fixed progress tracking in parallel mode
- üìù Improved error messages and troubleshooting guidance

### v0.0.1 (2025-12-18) - Initial Release
- Initial alpha release
- Fixed $LogSharePath scoping and default value issues
- Added administrative privilege validation
- Implemented parallel mode progress tracking
- Made remote log collection optional
- Updated documentation

### Planned Features
- Integration with Windows Update Service API
- Support for multiple definition file formats (FEP, NIS)
- Rollback capability for failed updates
- Integration with monitoring systems (SCOM, Splunk, etc.)
- Differential update support (only update outdated systems)
- Web-based dashboard for monitoring

## Best Practices

### For Production Deployments

1. **Test in a Lab First**
   - Run in `-WhatIfMode` to validate configuration
   - Test on 2-3 computers before full deployment
   - Verify email notifications work correctly

2. **Scheduled Task Configuration**
   ```powershell
   # Use a dedicated service account
   # Set "Run whether user is logged on or not"
   # Set "Run with highest privileges"
   # Schedule for off-peak hours (e.g., 2 AM)
   ```

3. **Network Share Management**
   - Keep only the 2-3 most recent definition files
   - Archive older files to prevent accidental use
   - Monitor share disk space (definitions are ~200 MB each)

4. **Monitoring & Alerting**
   - Enable email notifications for all production runs
   - Monitor HTML reports for failure trends
   - Set up alerts for >5% failure rate
   - Review CSV exports weekly for version compliance

5. **Documentation**
   - Document your hosts.conf exclusions
   - Keep a changelog of when you update definitions
   - Document any custom configurations or exclusions

### For Large Environments (500+ Computers)

1. **Batch Processing**
   - Consider breaking into geographical batches
   - Run different sites at different times
   - Prevents overwhelming file share or network

2. **Network Optimization**
   - Place file share close to target systems (DFS)
   - Monitor network utilization during runs
   - Adjust `-ParallelThreads` based on bandwidth

3. **Error Handling**
   - Review per-host logs for persistent failures
   - Create separate hosts.conf for problematic systems
   - Investigate hard failures immediately

4. **Reporting**
   - Archive HTML reports for compliance
   - Export CSV to database for trending
   - Create dashboards showing version compliance over time

### Security Considerations

1. **Credential Management**
   - Use Group Managed Service Accounts (gMSA) when possible
   - Store SMTP credentials securely (script uses DPAPI)
   - Rotate service account passwords regularly
   - Never commit credential files to version control

2. **Network Isolation**
   - Run from management VLAN if available
   - Ensure WinRM traffic is encrypted (default)
   - Limit `-LogSharePath` access to admins only

3. **Audit Trail**
   - Preserve log files for compliance (30+ days)
   - Include script runs in change management process
   - Document emergency update procedures

## Contributing

Contributions are welcome! Please feel free to submit issues, feature requests, or pull requests.

**How to Contribute:**

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit your changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

**Areas for Contribution:**
- Additional output formats (JSON, XML)
- Integration with monitoring systems
- Support for other antivirus products
- Localization/internationalization
- Additional reporting features

## License

This project is licensed under the MIT License - see the [LICENSE.txt](LICENSE.txt) file for details.

## Author

**Kismet Agbasi**
- GitHub: [@kismetgerald](https://github.com/kismetgerald)
- Email: KismetG17@gmail.com

*AI Contributors: ClaudeAI, Grok*

## Support

**Documentation:**
- [Quick Reference](README.md) - This file
- [Detailed Technical Documentation](claude.md) - Deep dive into architecture and internals

**Getting Help:**
- [GitHub Issues](https://github.com/kismetgerald/Update-DefenderOffline/issues) - Bug reports and feature requests
- [Discussions](https://github.com/kismetgerald/Update-DefenderOffline/discussions) - Questions and community support

**Before Opening an Issue:**
1. Check the [Troubleshooting](#troubleshooting) section
2. Review existing issues to avoid duplicates
3. Include log file excerpts when reporting bugs
4. Specify PowerShell version and environment details

---

**‚≠ê If this project helps you, please consider giving it a star!**

**üí¨ Questions? Open a [discussion](https://github.com/kismetgerald/Update-DefenderOffline/discussions)**

**üêõ Found a bug? [Report it](https://github.com/kismetgerald/Update-DefenderOffline/issues)**
